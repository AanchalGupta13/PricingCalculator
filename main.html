<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AWS Pricing Calculator</title>
    <link rel="stylesheet" href="styles/styles.css">
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1040.0.min.js"></script>
</head>

<body>
    <div class="container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo">
                <img src="assets/images/bbt-logo.svg" alt="Logo" class="logo-img">
            </div>

            <h4 style="text-align: center; color: white;">AWS Pricing Calculator</h4>

            <nav class="nav">
                <a href="#" id="priceBotBtn" class="nav-item active">Price Assistant</a>
                <a href="#" id="excelOpsBtn" class="nav-item">Excel Operations</a>
            </nav>

            <div class="help">
                <p>Help</p>
                <button class="info-button" onclick="toggleInfoPanel()"><img src="assets/images/about.svg"
                        class="icon"> About Product</button>
                <button class="info-button" onclick="togglePrivacyPanel()"><img src="assets/images/privacy.svg"
                        class="icon"> Privacy</button>
                <button class="info-button" onclick="toggleUserGuidePanel()"><img src="assets/images/user-guide.svg"
                        class="icon"> User Guide</button>
            </div>

            <div class="sidebar-footer">
                <p class="usage-info"><div id="subscriptionStatus" class="usage-counter">
                    <div id="statusMessage"></div>
                    <div>File Uploads: <span id="uploadCountDisplay">0</span>/<span id="maxUploads">3</span></div>
                    <div>Queries used: <span id="queryCountDisplay">0</span>/<span id="maxQueries">6</span></div>
                </div>
                </p>
                <div id="subscribeButtonContainer">
                    <button onclick="handleSubscription()" class="subscribe">Subscribe</button>
                </div>
                <div id="userInfoContainer" class="user-info-container"></div>
                <a href="#" class="signout" onclick="logout()"><img src="assets/images/logout.svg" class="icon"> Sign
                    Out</a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">

            <!-- Info Panel (hidden by default) -->
            <div class="info-panel" id="infoPanel">
                <button class="close-button" onclick="toggleInfoPanel()">❌</button>
                <h3>About AWS Pricing Calculator</h3>
                <p>A web-based Pricing Calculator platform designed to streamline AWS infrastructure cost estimation.
                    Users
                    can effortlessly upload configuration files through the interface, once it processed the file, users
                    can
                    seamlessly download the generated pricing report directly from the website. The platform also
                    features
                    an intelligent Price Assistant, allowing users to input server, storage, and database configuration
                    requirements to provide accurate, real-time AWS cost estimations.</p>

                <h3>Features</h3>
                <ul>
                    <li>Price Assistant supports multi server queries</li>
                    <li>Real-time pricing calculations</li>
                    <li>Secure file storage</li>
                    <li>Supports Dual Input Modes- File Upload/Download Section: Process Excel/CSV configuration sheets
                        &
                        Query Interface Price Assistant: Describe server requirements in plain English</li>
                </ul>
            </div>

            <!-- Privacy Panel (hidden by default) -->
            <div class="info-panel" id="privacyPanel">
                <button class="close-button" onclick="togglePrivacyPanel()">❌</button>
                <h3>Privacy & Policy</h3>
                <p>..............</p>
            </div>

            <!-- User-Guide Panel (hidden by default) -->
            <div class="info-panel" id="user-guidePanel">
                <button class="close-button" onclick="toggleUserGuidePanel()">❌</button>
                <h3>How to Use</h3>
                <ul>
                    <li>Upload your server configuration files (only Excel or csv format)</li>
                    <li>Select your result file and download</li>
                    <li>Use the Price Assistant and can query like - <br>
                        <b>-</b> 24 Cores CPU, 128 GB RAM, 512GB SSD storage and Microsoft SQL Server database <br>
                        <b>-</b> 24 Core CPU, 128 GB RAM, 512GB SSD storage <br>
                        <b>-</b> 4 Core cpu, 32 gb ram for SUSE Operating System in US East (N. Virginia) Region <br>
                        <b>-</b> t2.medium <br>
                        <b>-</b> t4g.2xlarge instance type for RHEL <br>
                    </li>
                </ul>
            </div>

            <!-- PRICE Assistant VIEW -->
            <div id="priceBotSection" class="chat-container">
                <div class="chatbox" id="chatbox">
                    <div id="messages"></div>
                    <!-- Typing indicator div (hidden by default) -->
                    <div id="typingIndicator" class="typing-indicator" style="display: none;">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <span style="font-size: 14px;">Price Assistant is Analyzing...</span>
                    </div>
                </div>
                <div class="chat-input">
                    <input type="text" id="userInput" placeholder="Describe your server configuration...">
                    <button onclick="sendMessage()"><img src="assets/images/send.png" class="icon">Send</button>
                </div>
            </div>

            <!-- EXCEL VIEW -->
            <div id="excelSection" class="file-section" style="display: none;">     
                <h4 class="upload-heading">Powered by Advanced <span class="highlight">AI Models</span></h4>
                <p class="upload-subtext">Easily estimate and optimize your AWS costs with a few clicks</p>
                <div class="upload-card">
                    <div class="upload-box" onclick="document.getElementById('fileInput').click()">
                        <input type="file" id="fileInput" style="display: none;" accept=".xls,.xlsx,.xlsm,csv">
                        <button onclick="document.getElementById('fileInput').click()" class="btn">
                            <img src="assets/images/upload-icon.svg" class="upload-icon">
                        </button>
                        <p class="drag-text">Drag & drop files or <span class="browse-link" onclick="document.getElementById('fileInput').click()">Browse</span></p>
                        <p class="supported-types">Supported formats: .xls, .xlsx, .xlsm, .csv (Max size: <strong>1 MB</strong>)</p>
                        <div class="upload-info">
                            <div id="selectedFileName" style="margin-top: 10px;"></div>
                            <div id="uploadStatus" class="upload-status"></div>
                        </div>
                    </div>
                    <button onclick="uploadFile()" class="upload-action-btn"><img src="assets/images/upload.svg" class="upload-btn"> UPLOAD FILES</button>
                    <div id="uploadStatus" class="upload-status"></div>
                    <div class="sample-btn-row">
                        <p class="sample-p">No xls? Try This</p>
                        <div id="sampleFileContainer" style="display: none;">
                            <a href="assets/Sample_Input_template.xlsx" class="sample-excel-btn" download>
                            Sample Excel<img src="assets/images/xls.svg" class="icon">
                        </a>
                        </div>
                    </div>
                </div>

                <div class="result-card">
                    <div class="result-header">
                        <div class="result-text">
                            <h3>Powered by Advanced <span class="highlight1">AI Models</span></h3>
                            <p class="p2">Lorem ipsum dollar</p>
                        </div>
                        <button onclick="downloadSelectedFile()" class="download-main-btn">
                            <img src="assets/images/download.svg" alt="Download">
                            DOWNLOAD
                        </button>
                    </div>
                    <div class="result-content">
                        <div class="file-list" id="fileListContainer">
                        <!-- Dynamically populated with file rows -->
                        </div>
                    </div>
                </div>
            </div>
            </div>
        </main>
    </div>

    <script src="scripts/toast.js"></script>
    <script>
        // View switching functionality
        document.addEventListener('DOMContentLoaded', () => {
            const priceBotBtn = document.getElementById('priceBotBtn');
            const excelOpsBtn = document.getElementById('excelOpsBtn');
            const sampleFileContainer = document.getElementById('sampleFileContainer');


            function setActiveView(view) {
                // Hide all info panels
                document.getElementById('infoPanel').style.display = 'none';
                document.getElementById('privacyPanel').style.display = 'none';
                document.getElementById('user-guidePanel').style.display = 'none';

                // Show the selected view
                document.getElementById('priceBotSection').style.display = (view === 'pricebot') ? 'block' : 'none';
                document.getElementById('excelSection').style.display = (view === 'excel') ? 'block' : 'none';
                sampleFileContainer.style.display = (view === 'excel') ? 'block' : 'none';

                priceBotBtn.classList.toggle('active', view === 'pricebot');
                excelOpsBtn.classList.toggle('active', view === 'excel');
            }

            priceBotBtn.addEventListener('click', (e) => {
                e.preventDefault();
                setActiveView('pricebot');
            });

            excelOpsBtn.addEventListener('click', (e) => {
                e.preventDefault();
                setActiveView('excel');
            });

            // Default view
            const defaultView = localStorage.getItem("selectedView") || "pricebot";
            setActiveView(defaultView);
        });

        function toggleInfoPanel() {
            const panel = document.getElementById('infoPanel');
            const button = document.querySelector('button[onclick="toggleInfoPanel()"]');

            const isVisible = panel.style.display === 'block';
            panel.style.display = isVisible ? 'none' : 'block';

            // Toggle active class
            if (!isVisible) {
                button.classList.add('active');
            } else {
                button.classList.remove('active');
            }

            // Hide other panels and remove active class from others
            document.getElementById('privacyPanel').style.display = 'none';
            document.getElementById('user-guidePanel').style.display = 'none';
            document.querySelector('button[onclick="togglePrivacyPanel()"]').classList.remove('active');
            document.querySelector('button[onclick="toggleUserGuidePanel()"]').classList.remove('active');
        }

        function togglePrivacyPanel() {
            const panel = document.getElementById('privacyPanel');
            const button = document.querySelector('button[onclick="togglePrivacyPanel()"]');

            const isVisible = panel.style.display === 'block';
            panel.style.display = isVisible ? 'none' : 'block';

            if (!isVisible) {
                button.classList.add('active');
            } else {
                button.classList.remove('active');
            }

            document.getElementById('infoPanel').style.display = 'none';
            document.getElementById('user-guidePanel').style.display = 'none';
            document.querySelector('button[onclick="toggleInfoPanel()"]').classList.remove('active');
            document.querySelector('button[onclick="toggleUserGuidePanel()"]').classList.remove('active');
        }

        function toggleUserGuidePanel() {
            const panel = document.getElementById('user-guidePanel');
            const button = document.querySelector('button[onclick="toggleUserGuidePanel()"]');

            const isVisible = panel.style.display === 'block';
            panel.style.display = isVisible ? 'none' : 'block';

            if (!isVisible) {
                button.classList.add('active');
            } else {
                button.classList.remove('active');
            }

            priceBotBtn.addEventListener('click', (e) => {
                e.preventDefault();
                localStorage.setItem("selectedView", "pricebot");
                setActiveView('pricebot');
            });

            excelOpsBtn.addEventListener('click', (e) => {
                e.preventDefault();
                localStorage.setItem("selectedView", "excel");
                setActiveView('excel');
            });


            document.getElementById('infoPanel').style.display = 'none';
            document.getElementById('privacyPanel').style.display = 'none';
            document.querySelector('button[onclick="toggleInfoPanel()"]').classList.remove('active');
            document.querySelector('button[onclick="togglePrivacyPanel()"]').classList.remove('active');
        }

        // For token validation and user verification...
        const UNIFIED_API_ENDPOINT = 'https://wncxw70jjc.execute-api.ap-south-1.amazonaws.com/prod/payment/verify';
        const MAX_RETRY_ATTEMPTS = 3;
        let retryCount = 0;
        // Check subscription status on page load
        document.addEventListener('DOMContentLoaded', async function () {
            // Check URL parameters first
            const urlParams = new URLSearchParams(window.location.search);
            const storedEmail = localStorage.getItem("useremail");
            if (!storedEmail) {
                console.log("storedEmail is Empty");
            }
            else if (storedEmail === 'undefined') {
                let urlEmail = urlParams.get('email');
                if (urlEmail) {
                    localStorage.setItem("useremail", urlEmail);
                    // Optional: Clean URL without reloading
                    if (window.history.replaceState) {
                        const cleanUrl = window.location.pathname;
                        window.history.replaceState({}, document.title, cleanUrl);
                    }
                }
            }
            console.log("Page loaded - useremail:", storedEmail);
            // Redirect to login page if no token is found
            let token = localStorage.getItem("token");
            if (!token || token.trim() === "") {
                Toast.error("Unauthorized access. Redirecting...");
                window.location.href = "http://bellblaze-dev.s3-website.ap-south-1.amazonaws.com/login?DomainPath=/dev-pricing-calculator";
                return;
            }

            // Clean token
            token = cleanToken(token);

            // Decode the token to get user info
            // Remove URL parameters if present (like ?token=)
            if (token.includes('?token=')) {
                token = token.split('?token=')[1];
            }

            // Split the token into parts
            const parts = token.split('.');
            if (parts.length !== 3) {
                throw new Error('Invalid JWT format');
            }

            // Base64Url decode with padding support
            const base64Url = parts[1];
            const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
            const paddedBase64 = base64.padEnd(base64.length + (4 - base64.length % 4) % 4, '=');

            if (storedEmail === 'undefined' && urlEmail) {
                // Fallback: If email was lost, restore from URL value
                localStorage.setItem('useremail', urlEmail);
            }

            // Decode and parse
            const decodedPayload = JSON.parse(atob(paddedBase64));

            console.log('Decoded Payload:', decodedPayload);
            try {
                const username = decodedPayload.name;
                const useremail = decodedPayload.email;
                const provider_user_id = decodedPayload.sub;

                // Set default username if it's undefined or 'undefined'
                if (username === 'undefined') {
                    username = 'User'; // Default value
                }
                // Always store the values after validation
                localStorage.setItem("username", username || 'User');
                if (useremail && (localStorage.getItem('useremail') || !localStorage.getItem('useremail'))) {
                    localStorage.setItem('useremail', useremail);
                    console.log("Successfully updated useremail:", useremail)
                }
                localStorage.setItem("provider_user_id", provider_user_id);

                console.log(username);
                console.log(useremail);
                console.log(provider_user_id);

                // Verify user against database
                const isValidUser = await verifyUserWithDatabaseWithRetry();

                if (!isValidUser) {
                    Toast.error("User not authorized. Redirecting...");
                    window.location.href = "http://bellblaze-dev.s3-website.ap-south-1.amazonaws.com/login?DomainPath=/dev-pricing-calculator";
                    return;
                }

                displayUserName();
                checkSubscriptionStatus();
            } catch (error) {
                console.error('Error during authentication:', error);
                window.location.href = "http://bellblaze-dev.s3-website.ap-south-1.amazonaws.com/login?DomainPath=/dev-pricing-calculator";
            }
        });

        function cleanToken(token) {
            // Remove any URL parameters that might be attached to the token
            return token.split('?')[0].split('&')[0].trim();
        }

        function handleSubscription() {
            const token = localStorage.getItem('token');
            if (!token) {
                Toast.error("No token found—please log in again.");
            } else {
                const params = new URLSearchParams({
                    app_id: "pricing-calculator",
                    token: token
                });
                window.location.href = "subscribe.html?" + params.toString();
            }
        }

        async function verifyUserWithDatabaseWithRetry() {
            while (retryCount < MAX_RETRY_ATTEMPTS) {
                try {
                    const result = await verifyUserWithDatabase();
                    if (result) {
                        return true;
                    }

                    retryCount++;
                    if (retryCount < MAX_RETRY_ATTEMPTS) {
                        console.log(`Verification failed. Retrying (${retryCount})...`);
                        await new Promise(resolve => setTimeout(resolve, 1000)); // Wait 1 seconds before retry
                    }
                } catch (error) {
                    console.error(`Attempt ${retryCount + 1} failed:`, error);
                    retryCount++;
                    if (retryCount >= MAX_RETRY_ATTEMPTS) {
                        throw error;
                    }
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }
            return false;
        }

        async function verifyUserWithDatabase() {
            const useremail = localStorage.getItem("useremail");
            console.log("verify user with useremail:", useremail);
            const provider_user_id = localStorage.getItem("provider_user_id");
            try {
                // Prepare the request payload
                const payload = {
                    action: "verifyUser"
                };
                // Only add email if it's not null
                if (useremail) {
                    payload.email = useremail;
                }
                // Only add provider_user_id if it exists and is not 'undefined'
                if (provider_user_id && provider_user_id !== 'undefined') {
                    payload.provider_user_id = provider_user_id;
                }
                const response = await fetch(UNIFIED_API_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem("token")}`
                    },
                    body: JSON.stringify(payload)
                });
                console.log('received response:', response);

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error! status: ${response.status}, body: ${text}`);
                }
                const data = await response.json();
                console.log('Verification response', data);
                return data.isValidUser;
            } catch (error) {
                console.error('Error verifying user:', error);
                return false;
            }
        }

        function displayUserName() {
            const username = localStorage.getItem("username");
            if (username) {
                // Create a container for user info in the top-right corner
                let userContainer = document.getElementById('userInfoContainer');
                if (!userContainer) {
                    userContainer = document.createElement('div');
                    userContainer.id = 'userInfoContainer';
                    userContainer.className = 'user-info-container';
                    document.body.appendChild(userContainer);
                }

                // Actually display the username
                userContainer.innerHTML = `
                    <div class="user-display">
                         <span class="user-name">${username}</span>
                     </div>
                `;
            }
        }

        async function verifysubscriptionWithDatabase() {
            const useremail = localStorage.getItem("useremail");
            const provider_user_id = localStorage.getItem("provider_user_id");
            try {
                // Prepare the request payload
                const payload = {
                    action: "checkStatus"
                };
                // Only add email if it's not null
                if (useremail) {
                    payload.email = useremail;
                }
                // Only add provider_user_id if it exists and is not 'undefined'
                if (provider_user_id && provider_user_id !== 'undefined') {
                    payload.provider_user_id = provider_user_id;
                }
                const response = await fetch(UNIFIED_API_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });
                console.log('received response:', response);

                if (!response.ok) {
                    console.error('API Error Response:', await response.text());
                    throw new Error(`HTTP error! status: ${response.status}, body: ${text}`);
                }
                return await response.json();
            } catch (error) {
                console.error('Error verifying subscription:', error);
                return {
                    isSubscribed: false,
                    uploadCount: 0,
                    queryCount: 0,
                    maxUploads: 3,
                    maxQueries: 6,
                    remainingUploads: 3,
                    remainingQueries: 6
                };
            }
        }

        async function checkSubscriptionStatus() {
            const useremail = localStorage.getItem("useremail");
            const data = await verifysubscriptionWithDatabase();
            const isSubscribed = data.isSubscribed
            const subscriptionStatusDiv = document.getElementById('subscriptionStatus');
            const subscribeButtonContainer = document.getElementById('subscribeButtonContainer');

            if (data.isSubscribed) {
                // User is subscribed - show premium status
                subscriptionStatusDiv.innerHTML = `
                    <div class="premium-badge">
                        <strong>Premium User:</strong> Unlocked Premium Access
                    </div>
                    <div>File Uploads: <span id="uploadCountDisplay">${data.uploadCount}</span>/<span id="maxUploads">${data.maxUploads}</span></div>
                <div>Queries used: <span id="queryCountDisplay">${data.queryCount}</span>/<span id="maxQueries">${data.maxQueries}</span></div>
                `;
                // Hide subscribe button
                subscribeButtonContainer.style.display = 'none';
            } else {
                // User is not subscribed - show free tier limits
                subscriptionStatusDiv.innerHTML = `
                    <strong>Free Tier Limits:</strong>
                    <div>File Uploads: <span id="uploadCountDisplay">${data.uploadCount}</span>/<span id="maxUploads">${data.maxUploads}</span></div>
                    <div>Queries used: <span id="queryCountDisplay">${data.queryCount}</span>/<span id="maxQueries">${data.maxQueries}</span></div>
                `;
                // Show subscribe button
                subscribeButtonContainer.style.display = 'block';
            }
        }

        async function updateUsageCounters() {
            const useremail = localStorage.getItem("useremail");
            const data = await verifysubscriptionWithDatabase();

            // Update counters
            document.getElementById("uploadCountDisplay").textContent = data.uploadCount;
            document.getElementById("queryCountDisplay").textContent = data.queryCount;
            document.getElementById("maxUploads").textContent = data.maxUploads;
            document.getElementById("maxQueries").textContent = data.maxQueries;

            // Update subscription status display
            const statusMessage = document.getElementById("statusMessage");
            if (!statusMessage) {
                console.warn("Element with ID 'statusMessage' not found.");
                return;
            }
            if (data.isSubscribed) {
                statusMessage.innerHTML = '<div class="premium-badge"><strong>Premium User:</strong> Unlocked Premium Access</div>';
            } else {
                statusMessage.innerHTML = '<strong>Free Tier Limits:</strong>';
            }

            // Show/hide subscribe button
            document.getElementById("subscribeButtonContainer").style.display =
                data.isSubscribed ? 'none' : 'block';
        }

        document.addEventListener('DOMContentLoaded', function () {
            updateUsageCounters();
        });

        function logout() {
            // Clear all stored data
            localStorage.clear();
            clearFileList();

            // Redirect to the desired page
            window.location.href = "http://bellblaze-dev.s3-website.ap-south-1.amazonaws.com/products/our-solutions";
        }
    </script>
    <script src="scripts/script.js"></script>
    <script src="scripts/chat.js"></script>
</body>
</html>